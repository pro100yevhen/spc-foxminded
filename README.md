# FoxmindEd Activity Points Application

## Introduction
This application is designed for **FoxmindEd IT school** to **calculate sales managers' daily activity points** based on data received from **Pipedrive CRM webhooks**. It handles activities and deals updates to track the daily performance of the sales team.

---

## Pipedrive CRM Setup

### Webhooks Setup
The application now uses **Pipedrive webhook v2** for activity tracking. You can read more about webhook v2 here: [Pipedrive Webhook v2 Guide](https://pipedrive.readme.io/docs/guide-for-webhooks-v2).

To get started, you need to create the following webhooks in the **Pipedrive CRM** system (URL: [Foxminded Pipedrive](https://foxminded.pipedrive.com/)):

1. **For updated activities:**
    - **Event action:** `changed`
    - **Event object:** `activity`
    - **Endpoint URL:** `your-url/activity`

2. **For added activities:**
    - **Event action:** `added`
    - **Event object:** `activity`
    - **Endpoint URL:** `your-url/activity`

3. **For deals update:**
    - **Event action:** `changed`
    - **Event object:** `deal`
    - **Endpoint URL:** `your-url/deal`

### Authentication
For the correct functioning of webhooks, you need to add **username and password**. To get this, please ask **Ivan Shvirid** (Head of the Sales Department).

---

## Application Purpose
This application was created for **FoxmindEd IT school** to calculate **daily activity points** for sales managers. It processes activity and deal updates to compute performance metrics.

---

## Pipedrive API Token Setup

The application now requires the **PIPEDRIVE_TOKEN** for accessing Pipedrive data. You can retrieve this token from your **Personal Preferences** page on the Pipedrive settings: [Pipedrive API Settings](https://foxminded.pipedrive.com/settings/api).

In case you need the token updated on the server, please reach out to **Mykola Shornik**.

---

## Configuration Setup

### Environment Variables

To run the application, ensure the following environment variables are correctly set in your environment:

- **PIPEDRIVE_TOKEN**: The token to access Pipedrive.
- **Other environment variables** related to the database and server setup (these can be set through Docker Compose or directly in the environment).

#### Example Docker Compose Environment Setup:

```yaml
version: "3.8"
services:
  db:
    container_name: foxminded-activity-database
    image: postgres:16.4
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DB}

  back:
    container_name: backend
    image: 'openjdk:21-slim'
    restart: always
    ports:
      - "9080:80"
    environment:
      - SPRING_MAIN_BANNER-MODE=off
      - PIPEDRIVE_TOKEN=${PIPEDRIVE_TOKEN}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
```

---

## Docker Setup

The application uses **Docker** to handle both the database and backend service. Below is an example configuration from the `docker-compose.yml` file (only relevant sections included):

### Services:

- **PostgreSQL Database**:
    - Image: `postgres:16.4`
    - Port: `5432:5432`
    - Environment variables: `POSTGRES_PASSWORD`, `POSTGRES_USER`, `POSTGRES_DB`

- **Backend**:
    - Image: `openjdk:21-slim`
    - Port: `9080:80`
    - Environment variables: `SPRING_MAIN_BANNER-MODE`, `PIPEDRIVE_TOKEN`, `SPRING_DATASOURCE_URL`, etc.

---

## Activity and Deal Filters

### Deals Filter (`DealFilter`):
This filter ensures only relevant deals are processed based on allowed user IDs and deal stages.

- Checks the **user ID** and **deal stage ID** against allowed values from the configuration.
- Only deals with the status "open" are considered.

### Activities Filter (`ActivityFilter`):
This filter is used to ensure that only activities that meet certain criteria are processed.

- Only activities where **markedAsDoneTime** is today, **busyFlag** is true, and the activity is marked as done are accepted.
- Filters out activities with a reference type of "salesphone" as autogenerated events.

---

## Manager Points Configuration

The configuration for manager points is dynamic and can be updated using a simple form in the application. The configuration settings are stored in the `manager_points_configuration` table.

### Configuration Fields:
- **Allowed User IDs**: List of IDs for managers whose activities will be tracked.
- **Deal Stages IDs**: Stages of deals that should be considered.
- **Manager Points Normative**: The standard number of points a manager should reach daily.
- **Manager Points Call Coefficient**: Coefficient applied to calculate points based on calls.
- **Manager Points Test Period Coefficient**: Coefficient applied during the manager's test period.
- **Bonus for Test Periods Count**:
    - `manager_points_bonus_under_3`: Bonus for fewer than 3 test periods.
    - `manager_points_bonus_equal_3`: Bonus for exactly 3 test periods.
    - `manager_points_bonus_over_4`: Bonus for more than 4 test periods.

---

## Manager Points Calculation

The application listens for events such as `ActivitySavedEvent` to calculate manager points. It updates points based on the number of activities completed by the manager, taking into account the following factors:

- **Activity count**: Increments the number of activities done by the manager.
- **Bonus Calculation**: Adds a bonus based on how many activities are completed during the day.
- **Test Period Bonus**: A coefficient is applied if the manager is in the test period.

### Points Formula:

```java
int intensity = activitiesCount * config.getManagerPointsCallCoefficient() +
    testPeriodCount * config.getManagerPointsTestPeriodCoefficient() +
    bonus;
```

Here, the intensity of activity is calculated based on calls, test period activities, and any applicable bonuses.

---

## Support Contacts

For any questions or further assistance:
- **Ivan Shvirid** (FoxmindEd Sales department)
- **Mykola Shornik** (FoxmindEd IT department)

---

This update includes the changes for webhook v2, the Pipedrive token requirements, and the removal of full `docker-compose.yml` details from the readme. Let me know if you need further adjustments.