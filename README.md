# FoxmindEd Activity Points Application

## Introduction
This application is designed for **FoxmindEd IT school** and is used to **calculate sales managers' daily activity points** based on data received from **Pipedrive CRM webhooks**. It handles activities and deals updates to track the daily performance of the sales team.

---

## Pipedrive CRM Setup

### Webhooks Setup
To get started, you need to create **three webhooks** in the **Pipedrive CRM** system (URL: [Foxminded Pipedrive](https://foxminded.pipedrive.com/)):

1. **For updated activities:**
    - **Event action:** `updated`
    - **Event object:** `activity`
    - **Endpoint URL:** `your-url/activity`

2. **For added activities:**
    - **Event action:** `added`
    - **Event object:** `activity`
    - **Endpoint URL:** `your-url/activity`

3. **For deals update:**
    - **Event action:** `update`
    - **Event object:** `deal`
    - **Endpoint URL:** `your-url/deal`

### Authentication
For the correct functioning of webhooks, you need to add **username and password**. To get this, please ask **Ivan Shvirid** (Head of the Sales Department).

---

## Application Purpose
This application was created for **FoxmindEd IT school** to calculate **daily activity points** for sales managers. It processes activity and deal updates to compute performance metrics.

---

## Configuration Setup

### Configuration File

The application uses a configuration file named `backend-local.properties` to manage server settings and database connections. You need to update the `application.properties` file according to your environment.

#### Key Settings:

- **Server Properties**:
    - `server.address=0.0.0.0` (or `localhost` for local use)
    - `server.port=8080`

- **Database Connection**:
    - `spring.datasource.url=jdbc:postgresql://localhost:5555/activity` (Update if using Docker or other environments)

Ensure these settings match your environment.

---

## Docker Setup

The application uses **Docker** to handle both the database and backend service. Below is an example configuration from the `docker-compose.yml`:

### Services:
- **PostgreSQL Database**:
    - Image: `postgres:16.4`
    - Port: `5432:5432`
    - Environment:
        - `POSTGRES_PASSWORD=P@ssw0rd1234!`
        - `POSTGRES_USER=admin`
        - `POSTGRES_DB=activity`

- **Backend**:
    - Image: `openjdk:21-slim`
    - Port: `9080:80`
    - Environment:
        - `SPRING_MAIN_BANNER-MODE=off`
        - `SPRING_PROFILES_ACTIVE=local`
    - Command: `java -jar /app/app.jar`

---

## Activity and Deal Filters

### Deals Filter (`DealFilter`):
This filter ensures only relevant deals are processed based on allowed user IDs and deal stages.

- Checks the **user ID** and **deal stage ID** against allowed values from the configuration.
- Only deals with the status "open" are considered.

### Activities Filter (`ActivityFilter`):
This filter is used to ensure that only activities that meet certain criteria are processed.

- Only activities where **markedAsDoneTime** is today, **busyFlag** is true, and the activity is marked as done are accepted.
- Filters out activities with a reference type of "salesphone" as autogenerated events.

---

## Manager Points Configuration

The configuration for manager points is dynamic and can be updated using a simple form in the application. The configuration settings are stored in the `manager_points_configuration` table.

### Configuration Fields:
- **Allowed User IDs**: List of IDs for managers whose activities will be tracked.
- **Deal Stages IDs**: Stages of deals that should be considered.
- **Manager Points Normative**: The standard number of points a manager should reach daily.
- **Manager Points Call Coefficient**: Coefficient applied to calculate points based on calls.
- **Manager Points Test Period Coefficient**: Coefficient applied during the manager's test period.
- **Bonus for Test Periods Count**:
    - `manager_points_bonus_under_3`: Bonus for fewer than 3 test periods.
    - `manager_points_bonus_equal_3`: Bonus for exactly 3 test periods.
    - `manager_points_bonus_over_4`: Bonus for more than 4 test periods.

---

## Manager Points Calculation

The application listens for events such as `ActivitySavedEvent` to calculate manager points. It updates points based on the number of activities completed by the manager, taking into account the following factors:

- **Activity count**: Increments the number of activities done by the manager.
- **Bonus Calculation**: Adds a bonus based on how many activities are completed during the day.
- **Test Period Bonus**: A coefficient is applied if the manager is in the test period.

### Points Formula:

```java
int intensity = activitiesCount * config.getManagerPointsCallCoefficient() +
    testPeriodCount * config.getManagerPointsTestPeriodCoefficient() +
    bonus;
```

Here, the intensity of activity is calculated based on calls, test period activities, and any applicable bonuses.

---

## Testing and Development

To test the application locally:
1. Set up your Docker environment as specified.
2. Ensure that the `application.properties` file is properly configured for local development.
3. Access the system via the specified port (`localhost:8080` or similar).
4. Update manager points configuration through the web interface, ensuring you have appropriate login credentials.

---

### Example points calculate

Let's walk through an example based on your configuration:

```plaintext
manager_points_normative: 50
manager_points_call_coefficient: 2
manager_points_test_period_coefficient: 8
manager_points_bonus_under_3: 0
manager_points_bonus_equal_3: 5
manager_points_bonus_over_4: 20
```

Assume the following values for a sales manager:

- **Activities count**: 5
- **Test period count**: 4
- **Bonus**: Based on `testPeriodCount`, this manager will receive the `manager_points_bonus_over_4` bonus of 20.

### Steps for calculation:

1. **Activities Points**:
    - `activitiesCount = 5`
    - `managerPointsCallCoefficient = 2`
    - Activities points = `5 * 2 = 10`

2. **Test Period Points**:
    - `testPeriodCount = 4`
    - `managerPointsTestPeriodCoefficient = 8`
    - Test period points = `4 * 8 = 32`

3. **Bonus**:
    - Since `testPeriodCount = 4`, the bonus is `20` (as per `manager_points_bonus_over_4`).

4. **Total Points**:
    - Total points = Activities points + Test period points + Bonus
    - Total points = `10 + 32 + 20 = 62`

### Final Points for the Manager:
- The calculated points for the manager would be **62** based on this configuration and activity level.

---

## Support Contacts

For any questions or further assistance:
- **Ivan Shvirid** (FoxmindEd Sales department)
- **Mykola Shornik** (FoxmindEd IT department)

---